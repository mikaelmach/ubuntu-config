---
- name: Update apt and install base packages
  apt:
    name:
      - curl
      - wget
      - openssh-server
      - git
      - unzip
      - python3
      - python3-pip
      - zsh
      - fzf
      - nodejs
      - npm
    state: present
    update_cache: yes

- name: Configure Git user settings
  become: false
  vars:
    git_user_name: "Michael"
    git_user_email: "michael@example.com"
    git_editor: "nvim"
  ansible.builtin.shell: |
    git config --global user.name "{{ git_user_name }}"
    git config --global user.email "{{ git_user_email }}"
    git config --global core.editor "{{ git_editor }}"
  args:
    executable: /bin/bash
  changed_when: false

- name: Ensure SSH service is enabled and running
  become: true
  ansible.builtin.service:
    name: ssh
    state: started
    enabled: true

- name: Set SSH key variables
  set_fact:
    ssh_key_path: "/home/{{ user }}/.ssh/id_ed25519"
    ssh_key_comment: "{{ user }}@{{ ansible_hostname }}"

- name: Generate SSH key for Git
  become: true 
  ansible.builtin.command: >
    ssh-keygen -t ed25519 -C "{{ ssh_key_comment }}" -f "{{ ssh_key_path }}" -N ""
  args:
    creates: "{{ ssh_key_path }}"
  register: ssh_keygen_result

- name: Ensure SSH agent is running and key is added
  become: false
  ansible.builtin.shell: |
    eval "$(ssh-agent -s)"
    ssh-add "{{ ssh_key_path }}"
  args:
    executable: /bin/bash
  when: ssh_keygen_result.changed

- name: Display public SSH key for GitHub setup
  become: false
  ansible.builtin.shell: cat "{{ ssh_key_path }}.pub"
  register: ssh_pubkey
  changed_when: false

- name: Show SSH public key
  ansible.builtin.debug:
    msg: |
      Add this SSH key to your Git provider (e.g., GitHub):
      {{ ssh_pubkey.stdout }}
